<?php

/**
 * 2 factor authentication user settings 
 *
 * @author Gyula Szabo, MTA SZTAKI
 * @package simpleSAMLphp
 * @version $Id$
 */

// Get config object
$globalConfig = SimpleSAML_Configuration::getInstance();
$authority = 'ldapandyubi';

$as = new SimpleSAML_Auth_Simple($authority);
$as->requireAuth();
$attributes = $as->getAttributes();
$uid = $attributes['uid'][0];


//$ldapandyubi = $as->getAuthSource();
$ldapandyubi = SimpleSAML_Auth_Source::getById($authority);

// If request is a logout request
if(array_key_exists('logout', $_REQUEST)) {
    $as->logout('/' . $globalConfig->getBaseURL() . 'logout.php');
}

if(array_key_exists('enable', $_REQUEST)) {
  $ldapandyubi->enable2fa($uid);
}

if(array_key_exists('disable', $_REQUEST)) {
  $ldapandyubi->disable2fa($uid);
}

if(array_key_exists('registerYubikey', $_REQUEST)) {
  $yubi_id = $ldapandyubi->getYubiKeyPrefix($_REQUEST['registerYubikey']);
  $ldapandyubi->registerYubikey($uid,$yubi_id);
}

if(array_key_exists('deleteYubikey', $_REQUEST)) {
  $ldapandyubi->deleteYubikey($uid,$_REQUEST['deleteYubikey']);
}

if(array_key_exists('generatePOTPs', $_REQUEST)) {
  $ldapandyubi->generatePOTPs($uid);
}

$settings = array(
  'enabled' => $ldapandyubi->isEnabled2fa($uid),
  'yubi_id' => $ldapandyubi->listYubikey($uid),
);

$popts = $ldapandyubi->getPOTPs($uid);
if (count($popts)==0){
  $ldapandyubi->generatePOTPs($uid);
  $popts = $ldapandyubi->getPOTPs($uid);
}

$t = new SimpleSAML_XHTML_Template($globalConfig, 'ldapandyubi:settings.php');
$t->data['settings'] = $settings;
$t->data['attributes'] = $attributes;
$t->data['potps'] = $popts;
$t->data['config'] = $ldapandyubi;
$t->show();
exit();

?>
