<?php

/**
 * 2 factor authentication user settings 
 *
 * @author Gyula Szabo, MTA SZTAKI
 * @package simpleSAMLphp
 * @version $Id$
 */

// Get config object
$globalConfig = SimpleSAML_Configuration::getInstance();
$authority = 'admin';

$as = new SimpleSAML_Auth_Simple($authority);
$as->requireAuth();
$attributes = $as->getAttributes();


//$ldapandyubi = $as->getAuthSource();
$ldapandyubi = SimpleSAML_Auth_Source::getById('ldapandyubi');

// If request is a logout request
if(array_key_exists('logout', $_REQUEST)) {
    $as->logout('/' . $globalConfig->getBaseURL() . 'logout.php');
}

if(array_key_exists('enable', $_REQUEST)) {
  $ldapandyubi->enable2fa($_REQUEST['uid']);
}

if(array_key_exists('disable', $_REQUEST)) {
  $ldapandyubi->disable2fa($_REQUEST['uid']);
}

if(array_key_exists('registerYubikey', $_REQUEST)) {
  $yubi_id = $ldapandyubi->getYubiKeyPrefix($_REQUEST['registerYubikey']);
  $ldapandyubi->registerYubikey($_REQUEST['uid'],$yubi_id);
}

if(array_key_exists('deleteYubikey', $_REQUEST)) {
  $ldapandyubi->deleteYubikey($_REQUEST['uid'],$_REQUEST['deleteYubikey']);
}

$settings = array(
  'status' => $ldapandyubi->getStatuses(),
  'yubi_id' => $ldapandyubi->getYubikeys(),
);

$t = new SimpleSAML_XHTML_Template($globalConfig, 'ldapandyubi:administrator.php');
$t->data['settings'] = $settings;
$t->data['attributes'] = $attributes;
$t->data['config'] = $ldapandyubi;
$t->show();
exit();

?>
