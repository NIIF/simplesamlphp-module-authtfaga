<?php
$this->data['header'] = $this->t('{ldapandyubi:settings:header}');
$this->data['autofocus'] = 'otp';
$this->data['jquery'] = '1.6';
$this->data['head'] = '<link rel="stylesheet" type="text/css" href="/'. $this->data['baseurlpath'] .'module.php/ldapandyubi/resources/ldapandyubi.css" />' ;

$settings = $this->data['settings'];
$potps = $this->data['potps'];
$enable = $this->t('{ldapandyubi:settings:enable}');
$disable = $this->t('{ldapandyubi:settings:disable}');

$this->includeAtTemplateBase('includes/header.php');
?>

<?php
if ($this->data['errorcode'] !== NULL) {
?>
	<div style="border-left: 1px solid #e8e8e8; border-bottom: 1px solid #e8e8e8; background: #f5f5f5">
		<img src="/<?php echo $this->data['baseurlpath']; ?>resources/icons/experience/gtk-dialog-error.48x48.png" style="float: left; margin: 15px " />
		<h2><?php echo $this->t('{login:error_header}'); ?></h2>
B
		<p><b><?php echo $this->t('{errors:title_' . $this->data['errorcode'] . '}'); ?></b></p>
		<p><?php echo $this->t('{errors:descr_' . $this->data['errorcode'] . '}'); ?></p>
	</div>
<?php
}
?>

<a href="settings.php?logout=1" style="float: right;"><input type="button" value="<?= $this->t('{status:logout}')?>"></a>
	<h2 style=""><?php echo $this->t('{ldapandyubi:settings:header}'); ?></h2>

	<?php echo $this->t('{ldapandyubi:settings:intro}'); ?>
<?php if (count($settings['yubi_id'])>0):?>

<div class="settingsbox">
<h3><?php echo $this->t('{ldapandyubi:settings:status_header}'); ?></h3>
<p>
<?php echo $this->t('{ldapandyubi:settings:status_text}'); ?>
</p>
<div class="statusbox">
<form action="" name="status" method="POST">
<?= $settings["enabled"]?"<font color=\"green\">ON</font>":"<font color=\"red\">OFF</font>" ?>
 <input type="submit" name="<?= $settings["enabled"]?"disable":"enable" ?>" value="<?= $settings["enabled"]?$disable:$enable ?>">
</div>
<?php endif ?>
</form>

<h3><?php echo $this->t('{ldapandyubi:settings:yubikeys_header}'); ?></h3>
<p>
<?php echo $this->t('{ldapandyubi:settings:yubikeys_text}'); ?>
</p>
<div class="statusbox">
<?php foreach ($settings['yubi_id'] as $y) :?>
<form action="" method="POST">
<p>
<?php echo $y ?>
 <input type="hidden" name="deleteYubikey" value="<?= $y ?>">
 <input type="submit" value="<?= $this->t('{ldapandyubi:settings:delete_yubikey}') ?>">
</p>
</form>
<?php endforeach ?>
</div><!-- "statusbox" -->

<input id="registerYubikey" type="button" value="<?php echo $this->t('{ldapandyubi:settings:register_yubikey}'); ?> ">
<div id="registerForm">
 <form name="registerYubikey" action="" method="POST">
 <div class="registerbox">
 <input id="otp" name="registerYubikey">
 <input type="submit">
 </div>
 </form>
</div>

<h3><?php echo $this->t('{ldapandyubi:settings:potp_header}'); ?></h3>
<span id="showpotps" style="cursor: pointer;">mutat/rejt</span>
<div id="potp" style="display: none; width: 100%;">
<p>
<?php echo $this->t('{ldapandyubi:settings:potp_text}'); ?>
</p>
<div class="potps">
<table>
<?php for ($i=0;$i<12;$i++) : ?>
<? echo $i%3 == 0?"<tr>":"" ?>
<td><?= $potps[$i][0]>0?number_format($potps[$i][0], 0, ',', ' '):"-"?></td>
<? echo ($i+1)%3 == 0?"</tr>":"" ?>
<?php endfor ?>
</table>
</div><!-- potps -->
<form action="" method="POST">
<p>
 <input type="hidden" name="generatePOTPs" value="1">
 <input type="submit" value="<?= $this->t('{ldapandyubi:settings:potp_generatebutton}') ?>">
</p>
</form>
<form target="_blank" action="potpprint.php" method="POST">
 <input type="submit" value="<?= $this->t('{ldapandyubi:settings:potp_printbutton}') ?>">
</form>
</p>
</div><!-- "potp" -->
</div><!-- "settingsbox" -->

<?php

$this->includeAtTemplateBase('includes/footer.php');
?>
<script>
$(document).ready(function() {
    $('#registerForm').dialog({
          overlay: { opacity: 0.5, background: 'black'},
          title: '<?php echo $this->t('{ldapandyubi:settings:register_title}')?>',
          modal:true,
          autoOpen: false,
          width: 700
          });
  $('#registerYubikey').click(function() {
     $('#registerForm').dialog("open");
     $('#otp').focus();
  });
  $('#showpotps').click(function() {
     $('#potp').toggle("slow");
  });
});
</script>
